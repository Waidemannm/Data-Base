---APAGA---
DROP TABLE T_WMD_FEEDBACK CASCADE CONSTRAINTS;

DROP TABLE T_WMD_RESPOSTA_USUARIO CASCADE CONSTRAINTS;

DROP TABLE T_WMD_HABITO CASCADE CONSTRAINTS;

DROP TABLE T_WMD_USUARIO CASCADE CONSTRAINTS;

DROP SEQUENCE SQ_WMD_USUARIO;

DROP SEQUENCE SQ_WMD_HABITO;

DROP SEQUENCE SQ_WMD_RESPOSTA_USARIO;

DROP SEQUENCE SQ_WMD_FEEDBACK;

---CRIA---
--- DDL

CREATE TABLE T_WMD_USUARIO ( 
    ID_USUARIO NUMBER(9) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
    NM_USUARIO VARCHAR2(300) NOT NULL, 
    NR_IDADE NUMBER(3) NOT NULL,
    NM_GENERO VARCHAR2(10) NOT NULL CHECK (NM_GENERO IN ('MASCULINO', 'FEMININO', 'OUTRO')), 
    NM_EMAIL VARCHAR2(200) UNIQUE NOT NULL
);

CREATE TABLE T_WMD_HABITO (
    ID_HABITO NUMBER(9) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NM_TIPO VARCHAR2(50) NOT NULL CHECK (
        NM_TIPO IN (
            'SONO',
            'HIDRATAÇÃO',
            'ALIMENTAÇÃO',
            'HUMOR E ENERGIA',
            'ESTRESSE E FOCO',
            'OBSERVAÇÕES'
        )
    ),
    DS_HABITO VARCHAR2(200) NOT NULL,
    VL_UNIDADE VARCHAR2(20) NOT NULL CHECK (
        VL_UNIDADE IN (
            'HORAS',
            'LITROS',
            'ESCALA',
            'TEXTO LIVRE'
        )
    )
);

CREATE TABLE T_WMD_RESPOSTA_USUARIO ( 
    ID_RESPOSTA NUMBER(9) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
    ID_USUARIO NUMBER(9) NOT NULL, 
    ID_HABITO NUMBER(9) NOT NULL,
    VL_RESPOSTA NUMBER CHECK (VL_RESPOSTA >= 0),
    DS_OBSERVACOES VARCHAR2(500),
    FOREIGN KEY (ID_USUARIO) REFERENCES T_WMD_USUARIO(ID_USUARIO),
    FOREIGN KEY (ID_HABITO) REFERENCES T_WMD_HABITO(ID_HABITO)
);

CREATE TABLE T_WMD_FEEDBACK (
    ID_FEEDBACK NUMBER(9) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER(9) NOT NULL,
    ID_RESPOSTA NUMBER(9) NOT NULL UNIQUE,
    DS_MENSAGEM VARCHAR2(1000) NOT NULL,
    FOREIGN KEY (ID_USUARIO) REFERENCES T_WMD_USUARIO(ID_USUARIO),
    FOREIGN KEY (ID_RESPOSTA) REFERENCES T_WMD_RESPOSTA_USUARIO(ID_RESPOSTA)
);

CREATE SEQUENCE SQ_WMD_USUARIO
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

CREATE SEQUENCE SQ_WMD_HABITO
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

CREATE SEQUENCE SQ_WMD_RESPOSTA_USUARIO
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

CREATE SEQUENCE SQ_WMD_FEEDBACK
START WITH 1 
INCREMENT BY 1 
NOCACHE 
NOCYCLE;

--- DML
--Usuarios

INSERT INTO T_WMD_USUARIO VALUES(SQ_WMD_USUARIO.NEXTVAL, 'Moisés Waidemann', 18, 'MASCULINO', 'jrmolinillo@gmail.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Ana Beatriz Santos', 21, 'FEMININO', 'ana.beatriz.santos@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Lucas Ferreira', 25, 'MASCULINO', 'lucas.ferreira@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Mariana Oliveira', 19, 'FEMININO', 'mariana.oliveira@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Gabriel Costa', 22, 'MASCULINO', 'gabriel.costa@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Clara Mendes', 24, 'FEMININO', 'clara.mendes@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Rafaela Andrade', 20, 'FEMININO', 'rafaela.andrade@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Thiago Moreira', 23, 'MASCULINO', 'thiago.moreira@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'Sofia Martins', 27, 'FEMININO', 'sofia.martins@example.com');

INSERT INTO T_WMD_USUARIO VALUES (SQ_WMD_USUARIO.NEXTVAL, 'João Pedro Carvalho', 26, 'MASCULINO', 'joao.pedro.carvalho@example.com');

--habitos (possui regra de negocios)
INSERT INTO T_WMD_HABITO VALUES (SQ_WMD_HABITO.NEXTVAL, 'ALIMENTAÇÃO', 'Número de refeiçoes equilibradas consumidas (1 a 10)', 'ESCALA');

INSERT INTO T_WMD_HABITO VALUES (SQ_WMD_HABITO.NEXTVAL, 'HUMOR E ENERGIA', 'Escala de humor diário (1 a 5)', 'ESCALA');

INSERT INTO T_WMD_HABITO VALUES (SQ_WMD_HABITO.NEXTVAL, 'ESTRESSE E FOCO', 'Escala de estresse diário (1 a 5)', 'ESCALA');

INSERT INTO T_WMD_HABITO VALUES (SQ_WMD_HABITO.NEXTVAL, 'SONO', 'Qualidade do sono (1 a 5)', 'ESCALA');

INSERT INTO T_WMD_HABITO VALUES (SQ_WMD_HABITO.NEXTVAL, 'HIDRATAÇÃO', 'Número de litros de água consumido', 'LITROS');

INSERT INTO T_WMD_HABITO VALUES (SQ_WMD_HABITO.NEXTVAL, 'OBSERVAÇÕES', 'Anotações livres sobre o bem-estar', 'TEXTO LIVRE');

--respostas usuarios
INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 11, 7, 3, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 12, 7, 1, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 13, 7, 5, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 14, 10, 8, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 15, 8, 1, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 16, 9, 4, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 17, 11, 3, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 18, 11, 2, NULL);

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 19, 12, NULL, 'Não tive uma boa noite de sono, acordei toda hora');

INSERT INTO T_WMD_RESPOSTA_USUARIO VALUES(SQ_WMD_RESPOSTA_USUARIO.NEXTVAL, 20, 12, NULL, 'Fui treinar hoje');

--feedback
INSERT INTO T_WMD_FEEDBACK VALUES(SQ_WMD_FEEDBACK.NEXTVAL, 11, 11, 'A quantidade de alimentação foi ótima');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 12, 12, 'Você se alimentou pouco hoje, tente adicionar ao menos uma refeição equilibrada.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 13, 13, 'Ótimo nível de alimentação, mantendo uma rotina saudável.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 14, 14, 'Você consumiu muito, tente manter constância e qualidade nas refeições.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 15, 15, 'Baixa alimentação registrada, tente adicionar frutas ou proteínas ao dia.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 16, 16, 'Boa alimentação, seu equilíbrio diário está estável.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 17, 17, 'Manutenção adequada da alimentação, siga monitorando.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 18, 18, 'Número baixo de refeições, procure não pular refeições importantes.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 19, 19, 'Seu sono foi prejudicado hoje. Tente relaxar antes de dormir para melhorar a qualidade.');

INSERT INTO T_WMD_FEEDBACK VALUES (SQ_WMD_FEEDBACK.NEXTVAL, 20, 20, 'Boa rotina física! Seu treino contribuiu para o bem-estar mental e físico.');

--- DQL
--simples
SELECT U.NM_USUARIO AS NOME, U.NR_IDADE AS IDADE, U.NM_GENERO AS SEXO, U.NM_EMAIL AS EMAIL
FROM T_WMD_USUARIO U
WHERE U.NR_IDADE > 17
ORDER BY U.NM_USUARIO;

--junção de tabela
SELECT U.NM_USUARIO AS NOME, F.DS_MENSAGEM AS FEEDBACK
FROM T_WMD_FEEDBACK F INNER JOIN T_WMD_USUARIO U
ON (F.ID_USUARIO = U.ID_USUARIO)
ORDER BY U.NM_USUARIO;

-- funcao de grupo
SELECT H.NM_TIPO AS HABITO,
       AVG(R.VL_RESPOSTA) AS MEDIA
FROM T_WMD_RESPOSTA_USUARIO R
INNER JOIN T_WMD_HABITO H ON H.ID_HABITO = R.ID_HABITO
GROUP BY H.NM_TIPO;

--funcao com filtro HAVING
SELECT U.NM_USUARIO,
       AVG(R.VL_RESPOSTA) AS MEDIA_ALIMENTACAO
FROM T_WMD_RESPOSTA_USUARIO R
JOIN T_WMD_USUARIO U ON U.ID_USUARIO = R.ID_USUARIO
JOIN T_WMD_HABITO H ON H.ID_HABITO = R.ID_HABITO
WHERE H.NM_TIPO = 'ALIMENTAÇÃO'
GROUP BY U.NM_USUARIO
HAVING AVG(R.VL_RESPOSTA) > 3;




